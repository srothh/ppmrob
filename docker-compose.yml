version: "3"
volumes:
  workspace:
services:
  ros_master:
    image: ros:noetic-ros-base
    command: roscore
    stdin_open: true
    tty: true
    ports:
      - "11311:11311"
    networks:
      - ppmrob
  cv:
    build: ./src/cv/cv_node
    environment:
      - "ROS_MASTER_URI=http://ros_master:11311"
      - "ROS_LOG_LEVEL=info"
      - "PYTHONUNBUFFERED=1"
#      - DISPLAY=host.docker.internal:0 # Uncomment only if running VcXsrv on Windows (https://sourceforge.net/projects/vcxsrv/), it will show gui things like imshow(). Will cause crash without it.
    #      - "NVIDIA_VISIBLE_DEVICES=all" GPU needs extra work
    networks:
      - ppmrob
    depends_on:
      - ros_master
  listener:
    environment:
      - "ROS_MASTER_URI=http://ros_master:11311"
      - "ROS_LOG_LEVEL=info"
      - "PYTHONUNBUFFERED=1"
    build: src/listener
    ports:
      - "6000:6000"
    #    runtime: nvidia GPU needs extra work
    depends_on:
      - ros_master
  drone:
    build:
      context: ./src
      dockerfile: ./drone/Dockerfile
    environment:
      - "ROS_MASTER_URI=http://ros_master:11311"
      - "ROS_LOG_LEVEL=info"
      - "PYTHONUNBUFFERED=1"
    ports:
      - "8889:8889/udp"
      - "8890:8890/udp"
      - "11111:11111/udp"
    networks:
      - ppmrob    
    depends_on:
      - ros_master
  # DO NOT start drone_dummy together with drone
#  drone_dummy:
#    build:
#      context: ./src
#      dockerfile: ./drone_dummy/Dockerfile
#    environment:
#      - "ROS_MASTER_URI=http://ros_master:11311"
#      - "ROS_LOG_LEVEL=info"
#      - "PYTHONUNBUFFERED=1"
#    networks:
#      - ppmrob    
#    depends_on:
#      - ros_master
#  battery:
#    build: src/battery
#    environment:
#      - "ROS_MASTER_URI=http://ros_master:11311"
#      - "ROS_LOG_LEVEL=info"
#      - "PYTHONUNBUFFERED=1"
#    networks:
#      - ppmrob
#    depends_on:
#      - ros_master
  cockpit:
    build:
      context: ./src
      dockerfile: ./cockpit/Dockerfile
    environment:
      - "ROS_MASTER_URI=http://ros_master:11311"
      - "ROS_LOG_LEVEL=info"
      - "PYTHONUNBUFFERED=1"
      - "QT_X11_NO_MITSHM=1"
      - "DISPLAY=$DISPLAY"
    networks:
      - ppmrob
    volumes:
      - /tmp/.X11-unix:/tmp/.X11-unix
    depends_on:
      - ros_master
  control:
    build: ./src/control
    environment:
      - "ROS_MASTER_URI=http://ros_master:11311"
      - "ROS_LOG_LEVEL=info"
      - "PYTHONUNBUFFERED=1"
    ports:
      - "9006:9006"
    networks:
      - ppmrob
    depends_on:
      - ros_master
networks:
  ppmrob:
    driver: "bridge"
