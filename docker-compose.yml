version: "3"
volumes:
  workspace:
services:
  ros_master:
    image: ros:noetic-ros-base
    command: roscore
    stdin_open: true
    tty: true
    ports:
      - "11311:11311"
    networks:
      - ppmrob
  cv:
    build: ./src/cv/cv_node
    # environment:
    #   - DISPLAY=host.docker.internal:0 # Uncomment only if running VcXsrv on Windows (https://sourceforge.net/projects/vcxsrv/), it will show gui things like imshow(). Will cause crash without it.
    #   - "NVIDIA_VISIBLE_DEVICES=all" GPU needs extra work
    env_file:
      - docker.env
    networks:
      - ppmrob
    depends_on:
      - ros_master
    # healthcheck:
    #   # https://docs.docker.com/compose/compose-file/05-services/#healthcheck
    #   test: [ "CMD-SHELL", "./check_cv_health.sh" ]
    #   interval: 1m30s
    #   timeout: 30s
    #   retries: 5
    #   start_period: 30s
  drone:
    build:
      context: ./src
      dockerfile: ./drone/Dockerfile
    env_file:
      - docker.env
    ports:
      - "8889:8889/udp"
      - "8890:8890/udp"
      - "11111:11111/udp"
    networks:
      - ppmrob
    depends_on:
      - ros_master

  # DO NOT start drone_dummy together with drone
  # drone_dummy:
  #   build:
  #     context: ./src
  #     dockerfile: ./drone_dummy/Dockerfile
  #   env_file:
  #     - docker.env
  #   networks:
  #     - ppmrob
  #   depends_on:
  #     - ros_master

  cockpit:
    build:
      context: ./src
      dockerfile: ./cockpit/Dockerfile
    environment:
      - "QT_X11_NO_MITSHM=1"
      - "DISPLAY=$DISPLAY"
    env_file:
      - docker.env
    networks:
      - ppmrob
    volumes:
      - /tmp/.X11-unix:/tmp/.X11-unix
    depends_on:
      - ros_master
  control:
    build:
      dockerfile: ./src/control/Dockerfile
    env_file:
      - docker.env
    ports:
      - "9006:9006"
    networks:
      - ppmrob
    depends_on:
      - ros_master
  mapping:
    build:
      dockerfile: ./src/mapping/Dockerfile
    env_file:
      - docker.env
    ports:
      - "9007:9007"
    volumes:
      - ./src/mapping/occ_grid.npy:/catkin_ws/src/mapping/occ_grid.npy
    networks:
      - ppmrob
    depends_on:
      # Compose creates and removes services in dependency order (e.g., here ros_master is created before mapping and mapping is removed before ros_master)
      cv:
        # Set the condition under which dependency is considered satisfied
        # condition: service_healthy # Specifies that a dependency is expected to be "healthy" (as indicated by healthcheck) before starting a dependent service.
        condition: service_started
      ros_master:
        condition: service_started # same as default depends_on

  planner:
    build:
      # If not set explicitly, context defaults to project directory (.).
      # relative ==> resolved from the Compose file's parent folder
      # context: ./src/
      # relative ==> resolved from the build context
      dockerfile: ./src/planner/Dockerfile
    env_file:
      # paths are relative to the location of `compose.yml` file
      - docker.env
      - docker_planner_vars.env
    networks:
      - ppmrob
    depends_on:
      - ros_master
      - control
      - mapping

  # mapping_simulation:
  #   build: ./src/mapping_simulation
  #   env_file:
  #     - docker.env
  #   ports:
  #     - "9009:9009"
  #   networks:
  #     - ppmrob
  #   depends_on:
  #     - ros_master
  #   working_dir: /catkin_ws/src/mapping_simulation/scripts
  #   # stdin_open: true  # Keeps STDIN open
  #   # tty: true         # Allocates a pseudo-TTY

  rviz:
    build: ./src/rviz
    networks:
      - ppmrob
    depends_on:
      - ros_master
    environment:
      - "QT_X11_NO_MITSHM=1"
      - "DISPLAY=$DISPLAY"
      - ROS_MASTER_URI=http://ros_master:11311
    volumes:
      - /tmp/.X11-unix:/tmp/.X11-unix
  # rqt_graph:
  #   image: osrf/ros:noetic-desktop-full
  #   command: rqt_graph
  #   env_file:
  #     - docker.env
  #   depends_on:
  #     - ros_master
  #   networks:
  #     - ppmrob
  #   volumes:
  #     - /tmp/.X11-unix:/tmp/.X11-unix:rw
networks:
  ppmrob:
    driver: "bridge"
